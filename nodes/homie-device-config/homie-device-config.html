<script type="text/javascript">
  RED.nodes.registerType('homie-convention-broker-config', {
    category: 'config',
    defaults: {
      'mqtt-host': {value: '127.0.0.1', required: true},
      'mqtt-port': {value: 1883, required: true},
      tls: {type:"tls-config",required: false},
      usetls: {value: false},
      verifyservercert: { value: false},
      name: {value: 'Node-RED', required: true},
      homieName: {value: 'Node-RED', required: true},
      homieFriendlyName: {value: 'Node-RED', required: true},
      homieRoot: {value: '', required: false},
      storeGlobal: {value: false},
      homieDevices: [],
      homieData: {},
      timeout: {value: 0, required:true}
    },
    credentials: {
      username: {type:"text"},
      password: {type:"password"}
    },
    label: function() {
      return this['mqtt-host'] + ':' + this['mqtt-port'] + ' - ' + this.name;
    },
    oneditprepare: function () {
      if (typeof this.usetls === 'undefined') {
        this.usetls = false;
        $("#node-config-input-usetls").prop("checked",false);
      }
      function updateTLSOptions() {
        if ($("#node-config-input-usetls").is(':checked')) {
            $("#node-config-row-tls").show();
        } else {
            $("#node-config-row-tls").hide();
        }
      }
      updateTLSOptions();
      $("#node-config-input-usetls").on("click",function() {
          updateTLSOptions();
      });
    },
    oneditsave: function() {
      if (!$("#node-config-input-usetls").is(':checked')) {
          $("#node-config-input-tls").val("");
      }
    }
  });
</script>

<script type="text/x-red" data-template-name="homie-convention-broker-config">
  <div class="text/html form-row">
    <label for="node-config-input-mqtt-host"><i class="fa fa-globe"></i> MQTT host</label>
    <input type="text" id="node-config-input-mqtt-host">
  </div>

  <div class="form-row">
    <label for="node-config-input-mqtt-port"><i class="fa fa-globe"></i> MQTT port</label>
    <input type="number" min="1" max="65535" id="node-config-input-mqtt-port">
  </div>

  <div class="form-row">
    <label for="node-config-input-username"><i class="fa fa-user"></i> Username</label>
    <input type="text" id="node-config-input-username">
  </div>

  <div class="form-row">
    <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
    <input type="password" id="node-config-input-password">
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-config-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-usetls" style="width: auto"><i class="fa fa-key"></i> Enable secure (SSL/TLS) connection</label>
    <div id="node-config-row-tls" class="hide">
        <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-config-input-tls">TLS Configuration</label><input style="width: 300px;" type="text" id="node-config-input-tls">
    </div>
  </div>

  <div class="form-row">
      <label for="node-config-input-homieRoot"><i class="fa fa-label"></i> Base Topic</label>
      <input type="text" id="node-config-input-homieRoot" placeholder="auto-discover">
  </div>

  <div class="form-row">
    <label for="node-config-input-homieName"><i class="fa fa-tag"></i> Device name</label>
    <input type="text" id="node-config-input-homieName" placeholder="Node-RED">
  </div>
  
  <div class="form-row">
    <label for="node-config-input-homieFriendlyName"><i class="fa fa-tags"></i> Friendly name</label>
    <input type="text" id="node-config-input-homieFriendlyName" placeholder="Node-RED">
  </div>

  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-barcode"></i> Broker name</label>
    <input type="text" id="node-config-input-name" placeholder="Node-RED">
  </div>

  <div class="form-row">
    <label><i class="fa fa-database"></i> Context</label>
    <input type="checkbox" id="node-config-input-storeGlobal" style="display: inline-block; width: auto; vertical-align: top;">
    <label for="node-config-input-storeGlobal" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> expose homie device tree in global context</label>
  </div>
  
  <div class="form-row">
    <label for="node-config-input-timeout"><i class="fa fa-clock-o"></i> Timeout</label>
    <input type="number" min="0" max="60" id="node-config-input-timeout" style="width: 30%;">
    <label for="node-config-input-timeout" style="width: 70%;">&nbsp;&nbsp;sec for reading retained messages (0 = disabled)</label>
  </div>
</script>

<script type="text/x-red" data-help-name="homie-convention-broker-config">
  <p> <img src="https://homieiot.github.io/img/mqtt_homie.jpg"></img>
  </p>
  <p>
    Basic configuration to connect Node-RED to a MQTT broker and listen to incoming messages below the homie root topic.
    currently only unencrypted and connection without user/password identification are supported
  </p>
  <p></p>

	<b>Configuration</b>
    <ul>
        <li><b>Name</b> Optionally specify a internal name<for this configuration/li>
        <li><b>MQTT hots</b> Host address of the mqtt broker</li>
        <li><b>MQTT port</b> Port address of the mqtt broker</li>
        <li><b>Base Topic</b> Optionally enter a base topic to subscribe to. If empty the node will search for homie devices by subscribing to <code>+/+/$homie</code></li>
        <li><b>Homie name</b> Give this Node-Red server a unique name to be addressed directly by other homie nodes.</li>
   	</ul>
	<p></p>

  <h3>Details</h3>
    <p>
        The Homie convention defines a standardized way of how IoT devices and services announce themselves and their data on the MQTT broker.<br>
        It is thereby a crucial aspect on top of the MQTT protocol for <i>automatic discovery, configuration</i> and <i>usage</i> of devices and services.<br>
        Form more Information head over to <a href="https://homieiot.github.io/">https://homieiot.github.io/</a>
    </p>  

  <h3>References</h3>
    <ul>
        <li><a href="https://homieiot.github.io/">Homie Convetion</a> - full specification of the Homie Convetion</li>
        <li><a href="https://github.com/Christian-Me/node-red-contrib-homie-convention">GitHub</a> - the nodes github repository</li>
    </ul>
</script>