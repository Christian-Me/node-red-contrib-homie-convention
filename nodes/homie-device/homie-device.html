<script type="text/x-red" data-template-name="homie-convention-device">
  <style type="text/css">
    .btn-group {
        width: 70%;
    }
    .multiselect {
        width: 100%;
    }
    .form-row input.multiselect-search {
        width: 100%;
    }
    .multiselect-clear-filter {
        display: none;
    }
    .dropdown-menu {
        width: 100% !important;
    }
    .multiselect-container input[type="checkbox"] {
        display: none;
    }
    .multiselect-container > li > a > label.radio {
        margin: 5px;
        width: 90%;
        height: 100%;
        cursor: pointer;
        font-weight: 400;
        padding: 3px 20px 3px 20px;
    }
    .multiselect-container label.radio input[type="radio"] {
        display: none;
    }
  </style>

  <link rel="stylesheet" href="static/css/bootstrap-multiselect.css" type="text/css" />

  <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
      <label for="node-input-broker"><i class="fa fa-exchange"></i> Broker</label>
      <input id="node-input-broker">
  </div>
  
  <div class="form-row">
      <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-config-homie-tabs"></ul>
  </div>
  <div id="node-config-homie-tabs-content" style="min-height: 170px;">

      <div id="homie-tab-basic" style="display:none">
        <div class="form-row">
            <label><i class="fa fa-info-circle"></i> Settable</label>
            <input type="checkbox" id="node-input-settable" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-settable" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> show only <code>$settable==true</code> properties.</label>
        </div>
        <div class="form-row">
          <label for="node-input-deviceID"><i class="fa fa-crosshairs"></i> Device</label>
          <select id="node-input-deviceID"></select>
        </div>
        <div class="form-row">
          <label for="node-input-nodeID"><i class="fa fa-crosshairs"></i> Node</label>
          <select id="node-input-nodeID"></select>
        </div>
        <div class="form-row">
          <label for="node-input-propertyID"><i class="fa fa-crosshairs"></i> Property</label>
          <select id="node-input-propertyID"></select>
        </div>
      </div>

      <div id="homie-tab-extra" style="display:none">
        <div class="form-row">
            <label><i class="fa fa-info-circle"></i> Aditional</label>
            <input type="checkbox" id="node-input-infoTiming" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-infoTiming" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> include <code>msg.timing</code></label>
        </div>
        <div class="form-row">
            <label>&nbsp</label>
            <input type="checkbox" id="node-input-infoError" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-infoError" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> include <code>msg.error</code></label>
        </div>
        <div class="form-row">
            <label>&nbsp</label>
            <input type="checkbox" id="node-input-infoAttributes" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-infoAttributes" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> include <code>msg.attributes</code></label>
        </div>
      </div>

      <div id="homie-tab-dashboard" style="display:none">
        <div class="form-row">
          <label for="node-input-uiNode"><i class="fa fa-tachometer"></i> Node</label>
          <select id="node-input-uiNode">
            <option value="none">none</option>
            <option value="uiButton">button</option>
            <option value="uiButtonSwitch">button as switch</option>
            <option value="uiChart">chart</option>
            <option value="uiColor">color picker</option>
            <option value="uiDropdown">dropdown</option>
            <option value="uiGauge">gauge</option>
            <option value="uiNumeric">numeric</option>
            <option value="uiSlider">slider</option>
            <option value="uiSwitch">switch</option>
            <option value="uiText">text</option>
            <option value="uiTextImput">text imput</option>
          </select>
        </div>

        <div id="node-config-homie-uiOptions">

          <div id="node-config-homie-uiOption-uiDropdown" style="display:none">
            <div class="form-row">
              <label for="node-input-uiPlaceName"><i class="fa fa-info"></i> Placeholder</label>
              <input type="text" id="node-input-uiPlaceName" placeholder="enter placeholder text">
            </div>
            <div class="form-row">
              <label><i class="fa fa-list"></i> ui_control</label>
              <input type="checkbox" id="node-input-uiControlDropdown" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiControlDropdown" style="width: 70%;">&nbsp;&nbsp;convert <b>$datatype</b> and <b>$format</b> to <code>msg.ui_control</code></label>
            </div>
          </div>
          
          <div id="node-config-homie-uiOption-uiMinMax" style="display:none">
            <div class="form-row">
              <label><i class="fa fa-sliders"></i> ui_control</label>
              <input type="checkbox" id="node-input-uiControlMinMax" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiControlMinMax" style="width: 70%;">&nbsp;&nbsp;convert <b>$format</b> <b>min:max</b> to <code>msg.ui_control</code></label>
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiFormat" style="display:none">
            <div class="form-row">
              <label><i class="fa fa-sliders"></i> ui_control</label>
              <input type="checkbox" id="node-input-uiFormat" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiFormat" style="width: 70%;">&nbsp;&nbsp;use <b>$unit</b> for <b>Format:</b> <code>{{value}} $unit</code></label>
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiColorButton" style="display:none">
            <div class="form-row">
              <label><i class="fa fa-bold"></i> Label</label>
              <input type="color" id="node-input-uiColor1" class="nr-db-field-themeColor"  style="position:initial;">
              <label for="node-input-uiColor1" style="width: 70%;">&nbsp;&nbsp;foreground color for icon and text</label>
            </div>
            <div class="form-row">
                <label><i class="fa fa-square"></i> Background</label>
                <input type="color" id="node-input-uiBgColor1" class="nr-db-field-themeColor"  style="position:initial;">
                <label for="node-input-uiBgColor1" style="width: 70%;">&nbsp;&nbsp;background color</label>
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiColorSwitch" style="display:none"> 
            <div class="form-row">
                <label><i class="fa fa-check-square-o"></i> ON</label>
                <input type="color" id="node-input-uiColorON" class="nr-db-field-themeColor"  style="position:initial;">
                <label for="node-input-uiColorON" style="width: 70%;">&nbsp;&nbsp;color for <B>true/on</b> state</label>
            </div>
            <div class="form-row">
              <label><i class="fa fa-square-o"></i> OFF</label>
              <input type="color" id="node-input-uiColorOFF" class="nr-db-field-themeColor"  style="position:initial;">
              <label for="node-input-uiColorOFF" style="width: 70%;">&nbsp;&nbsp;color for <B>false/off</b> state</label>
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiColorPredicted" style="display:none"> 
            <div class="form-row">
              <label><i class="fa fa-question-circle-o"></i> predicted</label>
              <input type="color" id="node-input-uiColorPredicted" class="nr-db-field-themeColor"  style="position:initial;">
              <label for="node-input-uiColorPredicted" style="width: 1%;">&nbsp;&nbsp</label>
              <input type="checkbox" id="node-input-uiUseColorPredicted" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiUseColorPredicted" style="width: 50%;">&nbsp;&nbsp;use color for <b>predicted</b> ON state</label>
            </div>
            <div class="form-row">
              <label><i class="fa fa-question-circle-o"></i></label>
              <input type="color" id="node-input-uiColorPredictedOff" class="nr-db-field-themeColor"  style="position:initial;">
              <label for="node-input-uiColorPredictedOff" style="width: 1%;">&nbsp;&nbsp</label>
              <input type="checkbox" id="node-input-uiUseColorPredictedOff" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiUseColorPredictedOff" style="width: 50%;">&nbsp;&nbsp;use color for <b>predicted</b> OFF state</label>
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiSwitchPredicted" style="display:none"> 
            <div class="form-row">
              <label><i class="fa fa-refresh"></i> ui_control</label>
              <input type="checkbox" id="node-input-uiSwitchPredicted" style="display: inline-block; width: auto; vertical-align: top;">
              <label for="node-input-uiSwitchPredicted" style="width: 70%;">&nbsp;&nbsp;use predicted state until confirmation received</label>
            </div>
          </div>


          <div id="node-config-homie-uiOption-uiUseSwitchPredicted" style="display:none"> 
              <div class="form-row">
                <label></label>
                <label for="node-input-uiSwitchColorPredictedON" style="width: 5%;">ON </label>
                <input type="color" id="node-input-uiSwitchColorPredictedON" class="nr-db-field-themeColor"  style="position:initial;">
                <label for="node-input-uiSwitchIconPredictedON" style="width: 10%;">&nbsp;&nbsp;Icon</label>
                <input type="text" id="node-input-uiSwitchIconPredictedON" style="width: 40%;" splaceholder="Material, fa or Weather Icon">
              </div>
              <div class="form-row">
                <label></label>
                <label for="node-input-uiSwitchColorPredictedOFF" style="width: 5%;">OFF </label>
                <input type="color" id="node-input-uiSwitchColorPredictedOFF" class="nr-db-field-themeColor"  style="position:initial;">
                <label for="node-input-uiSwitchIconPredictedOFF" style="width: 10%;">&nbsp;&nbsp;Icon</label>
                <input type="text" id="node-input-uiSwitchIconPredictedOFF" style="width: 40%;" splaceholder="Material, fa or Weather Icon">
              </div>
            </div>

          <div id="node-config-homie-uiOption-uiTooltip" style="display:none">
            <div class="form-row">
              <label for="node-input-uiTooltip"><i class="fa fa-info"></i>&nbsp;Tooltip</label>
              <input type="text" id="node-input-uiTooltip" placeholder="enter tooltip text">
            </div>
          </div>

          <div id="node-config-homie-uiOption-uiIcon1" style="display:none">
            <div class="form-row">
              <label for="node-input-uiIcon1"><i class="fa fa-info"></i>&nbsp;Icon</label>
              <input type="text" id="node-input-uiIcon1" placeholder="Material, fa or Weather Icon">
            </div>
          </div>
  
          <div id="node-config-homie-uiOption-uiIcon2" style="display:none">
            <div class="form-row">
              <label for="node-input-uiIconON"><i class="fa fa-info"></i>&nbsp;ON icon</label>
              <input type="text" id="node-input-uiIconON" placeholder="Material, fa or Weather Icon">
            </div>
            <div class="form-row">
              <label for="node-input-uiIconOFF"><i class="fa fa-info"></i>&nbsp;OFF icon</label>
              <input type="text" id="node-input-uiIconOFF" placeholder="Material, fa or Weather Icon">
            </div>
          </div>

        </div>

        <div class="form-row">
          <label for="node-input-addLabel"><i class="fa fa-tags"></i> <code>msg.label</code></label>
          <select id="node-input-addLabel">
             <option value="none">none</option>
             <option value="mame">$name</option>
             <option value="custom">custom</option>
             <option value="device">device</option>
             <option value="node">node</option>
             <option value="property">property</option>
             <option value="device/node/property">Device/Node/Property</option>
             <option value="device/node">Device/Node</option>
          </select>
        </div>

        <div id="node-config-homie-labelOptions">
          <div id="node-config-homie-labelOption-custom" style="display:none">
            <div class="form-row">
              <label for="node-input-labelName"><i class="fa fa-label"></i> Custom Label</label>
              <input type="text" id="node-input-labelName" placeholder="$name if empty">
            </div>
          </div>
        <div id="node-config-homie-labelOption-name" style="display:none">
          <div class="form-row">
            <label>&nbsp</label>
            <input type="checkbox" id="node-input-labelTopic" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-labelTopic" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> <code>msg.topic=msg.label</code></label>
          </div>
          <div class="form-row">
            <label>&nbsp</label>
            <input type="checkbox" id="node-input-labelPayload" style="display: inline-block; width: auto; vertical-align: top;">
            <label for="node-input-labelPayload" style="width: 70%;">&nbsp;&nbsp;<i class="fa fa-clock"></i> <code>msg.payload=msg.label</code></label>
          </div>
        </div>
      </div>
    </div>
  </div>
        
  <div class="form-row node-homie-data-row"></div>
</script>

<script type="text/javascript">

  var treeList;

  // remebner last selection to prevent unnessesary Updates
  var lastDeviceID = '';
  var lastNodeID = '';
  var lastPropertyID = '';

	function configEditPrepare(node, allowEmpty) {

       function updateProperty(cntrlConfig, valueID, itemName) {
        if ( cntrlConfig ) {
          var config = {
            name: cntrlConfig.name,
            broker: cntrlConfig.id,
            // field name to query
            itemID: valueID,
            // filters to query
            deviceID: $('#node-input-deviceID').val(),
            nodeID: $('#node-input-nodeID').val(),
            propertyID: $('#node-input-propertyID').val(),
            queryValueID: valueID
          }
          console.log("updateProperty ("+itemName+") = ",cntrlConfig,config);
          $.getJSON("homieConvention/propertyInfo", config)
            .done( function(data) {
              console.log("homieConvention/propertyInfo: "+ JSON.stringify(data));
            })
            .fail( function(e1, e2, e3) {
              console.log("homieConvention/propertyInfo: error e1=" + JSON.stringify(e1));
              console.log("homieConvention/propertyInfo: error e2=" + JSON.stringify(e2));
              console.log("homieConvention/propertyInfo: error e3=" + JSON.stringify(e3));
            });        }
      }
      function setColourPickerColour(id, val, ed) {
                    $("#"+id).val(val);
                    $("#"+id).css("background-color", val);
                }

      function updateUiNodeOptions(cntrlConfig, valueID, itemName) {
        $("#node-config-homie-uiOptions").children().hide();
        switch(itemName) {
          case 'uiNumeric':
            $("#node-config-homie-uiOption-uiMinMax").show();
            $("#node-config-homie-uiOption-uiFormat").show();
            break;
          case 'uiGauge':
            $("#node-config-homie-uiOption-uiMinMax").show();
            break;
          case 'uiSlider':
            $("#node-config-homie-uiOption-uiMinMax").show();
            break;
          case 'uiChart':
            $("#node-config-homie-uiOption-uiMinMax").show();
            break
          case 'uiDropdown':
            $("#node-config-homie-uiOption-uiDropdown").show();
            break;
          case 'uiButton':
            $("#node-config-homie-uiOption-uiColorButton").show();
            $("#node-config-homie-uiOption-uiTooltip").show();
            $("#node-config-homie-uiOption-uiIcon1").show();
            break;
          case 'uiButtonSwitch':
            $("#node-config-homie-uiOption-uiColorButton").show();
            $("#node-config-homie-uiOption-uiColorSwitch").show();
            $("#node-config-homie-uiOption-uiColorPredicted").show();
            $("#node-config-homie-uiOption-uiTooltip").show();
            $("#node-config-homie-uiOption-uiIcon1").show();
            break;
          case 'uiSwitch':
            $("#node-config-homie-uiOption-uiColorSwitch").show();
            $("#node-config-homie-uiOption-uiTooltip").show();
            $("#node-config-homie-uiOption-uiIcon2").show();
            $("#node-config-homie-uiOption-uiSwitchPredicted").show();
            if ($('#node-input-uiSwitchPredicted').is(':checked')) $("#node-config-homie-uiOption-uiUseSwitchPredicted").show();
              else $("#node-config-homie-uiOption-uiUseSwitchPredicted").hide();
            break;
          case 'uiText':
            $("#node-config-homie-uiOption-uiFormat").show();
            break;
        }
      };

      function updateUiLabelOptions(cntrlConfig, valueID, itemName) {
        $("#node-config-homie-labelOptions").children().hide();
        switch(itemName) {
          case 'none': break;
          case 'custom': 
            $("#node-config-homie-labelOption-" + itemName).show();
            $("#node-config-homie-labelOption-name").show();
            break;
          default: $("#node-config-homie-labelOption-name").show();
        }
      };

      function updateItemSelection(cntrlConfig, valueID, itemName) {

        var itemSelectionEl = $('#node-input-'+ valueID);
        var treeData = [];

        itemSelectionEl.multiselect({
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,
            maxHeight: 300,
            disableIfEmpty: true,
            nonSelectedText: 'Select device...',
            disabledText: 'No items found...'
        });
        
        if ( cntrlConfig ) {
          var config = {
            name: cntrlConfig.name,
            broker: cntrlConfig.id,
            // field name to query
            itemID: valueID,
            // filters to query
            deviceID: $('#node-input-deviceID').val() || node.deviceID,
            nodeID: $('#node-input-nodeID').val() || node.nodeID,
            propertyID: $('#node-input-propertyID').val() || node.propertyID,
            addLabel: $('#node-input-addLabel').val() || node.addLabel,
            settable: $('#node-input-settable').is(':checked')
          }
          
          console.log("updateItemSelection ("+itemName+") = ",config);
          $.getJSON("homieConvention/deviceList", config)
            .done( function(data) {
              console.log(config.itemID,data);
              var items = data;
              if (config.itemID!="treeList") { // fill dropdown list exept for treeView updates
                itemSelectionEl.children().remove();

                items.sort(function(a,b) {
                  if ( a.name < b.name )
                    return -1;
                  else if ( a.name > b.name )
                    return 1;
                  else
                    return 0;
                });

                if (allowEmpty && !(config.settable && valueID=='propertyID')) // only add [any] wildcard if settable filter is not selcted and property list is updating
                  itemSelectionEl.append('<option value="[any]">[any]</option>');
                items.forEach(function (item) {
                  itemSelectionEl.append('<option>' + item.name + '</option>');
                  var it = itemSelectionEl.find('option').last();
                  it.attr('value', item.name);
                });
                itemSelectionEl.val(itemName);
                itemSelectionEl.multiselect('rebuild');
              } else { // fill treeList with selected properties
                treeList.treeList('data',items);
              }
            })
            .fail(function(e1, e2, e3) {
              console.log("error : " + JSON.stringify(e1));
            });
        } else console.log("Ups, no broker config!:",cntrlConfig);
    }
    
    console.log("configEditPrepare",node);
    console.log(" deviceID  : ",$('#node-input-deviceID').val());
    console.log(" nodeID    : ",$('#node-input-nodeID').val());
    console.log(" propertyID: ",$('#node-input-propertyID').val());
    console.log(" settable  : ",$('#node-input-settable').is(':checked'));
    
    setColourPickerColour("node-input-uiColor1", node.uiColor1);
    $('#node-input-uiColor1').change(function(ev) {
      setColourPickerColour("node-input-uiColor1", $('#node-input-uiColor1').val() || node.uiColor1);
    });
    setColourPickerColour("node-input-uiBgColor1", node.uiBgColor1);
    $('#node-input-uiBgColor1').change(function(ev) {
      setColourPickerColour("node-input-uiBgColor1", $('#node-input-uiBgColor1').val() || node.uiBgColor1);
    });
    setColourPickerColour("node-input-uiColorON", node.uiColorON);
    $('#node-input-uiColorON').change(function(ev) {
      setColourPickerColour("node-input-uiColorON", $('#node-input-uiColorON').val() || node.uiColorON);
    });
    setColourPickerColour("node-input-uiColorOFF", node.uiColorOFF);
    $('#node-input-uiColorOFF').change(function(ev) {
      setColourPickerColour("node-input-uiColorOFF", $('#node-input-uiColorOFF').val() || node.uiColorOFF);
    });
    setColourPickerColour("node-input-uiColorPredicted", node.uiColorPredicted);
    $('#node-input-uiColorPredicted').change(function(ev) {
      setColourPickerColour("node-input-uiColorPredicted", $('#node-input-uiColorPredicted').val() || node.uiColorPredicted);
    });
    setColourPickerColour("node-input-uiColorPredictedOff", node.uiColorPredictedOff);
    $('#node-input-uiColorPredictedOff').change(function(ev) {
      setColourPickerColour("node-input-uiColorPredictedOff", $('#node-input-uiColorPredictedOff').val() || node.uiColorPredictedOff);
    });
    setColourPickerColour("node-input-uiSwitchColorPredictedON", node.uiSwitchColorPredictedON);
    $('#node-input-uiSwitchColorPredictedON').change(function(ev) {
      setColourPickerColour("node-input-uiSwitchColorPredictedON", $('#node-input-uiSwitchColorPredictedON').val() || node.uiSwitchColorPredictedON);
    });
    setColourPickerColour("node-input-uiSwitchColorPredictedOFF", node.uiSwitchColorPredictedOFF);
    $('#node-input-uiSwitchColorPredictedOFF').change(function(ev) {
      setColourPickerColour("node-input-uiSwitchColorPredictedOFF", $('#node-input-uiSwitchColorPredictedOFF').val() || node.uiSwitchColorPredictedOFF);
    });

    $('#node-input-uiSwitchPredicted').change(function(ev) {
      if ($('#node-input-uiNode').val()=='uiSwitch' && $('#node-input-uiSwitchPredicted').is(':checked')) $("#node-config-homie-uiOption-uiUseSwitchPredicted").show();
        else $("#node-config-homie-uiOption-uiUseSwitchPredicted").hide();
    });

		$('#node-input-broker').change(function(ev) { // update device list if broker is changed (nodes and properties should update subsequently)
	        updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'deviceID', $('#node-input-deviceID').val() || node.deviceID);
		});
		$('#node-input-deviceID').change(function(ev) {
          updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'nodeID', $('#node-input-nodeID').val() || node.nodeID);
          if ($('#node-input-nodeID').val()=="[any]") // update property list if any node selected
            updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'propertyID', $('#node-input-propertyID').val() || node.propertyID);
          if (lastDeviceID!=$('#node-input-deviceID').val()) { // update tree List if Device ID differs.
            updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'treeList', $('#node-input-propertyID').val() || node.propertyID);
          }
          lastDeviceID=$('#node-input-deviceID').val();
		});
		$('#node-input-nodeID').change(function(ev) { // update property List if node changes
          updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'propertyID', $('#node-input-propertyID').val() || node.propertyID);
          if (lastNodeID!=$('#node-input-nodeID').val()) { // update tree List if node ID differs.
            updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'treeList', $('#node-input-propertyID').val() || node.propertyID);
          }
          lastNodeID=$('#node-input-nodeID').val();
    });
    $('#node-input-propertyID').change(function(ev) { // update property List if proptty selected
          updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'treeList', $('#node-input-propertyID').val() || node.propertyID);
    });
    $('#node-input-uiNode').change(function(ev) { // update uiNode features
          updateUiNodeOptions(RED.nodes.node($('#node-input-broker').val()),'', $('#node-input-uiNode').val() || node.uiNode);
    });
    $('#node-input-addLabel').change(function(ev) { // update uiLabel features
          updateUiLabelOptions(RED.nodes.node($('#node-input-broker').val()),'', $('#node-input-addLabel').val() || node.addLabel);
    });
    $('#node-input-settable').on("click",function() { // re-update property list if $setable filter setting is changed
          console.log("click");
          console.log(" settable  : ",$('#node-input-settable').is(':checked'));
	        updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'propertyID', $('#node-input-propertyID').val() || node.propertyID);
          updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'treeList', $('#node-input-propertyID').val() || node.propertyID);
    });
	}

  function resizeNodeList() {
        var rows = $("#dialog-form>div:not(.node-homie-data-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.size();i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-homie-data-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        $(".node-homie-data-row").css("height",height+"px");
    }

  // register homie-convention-device

  RED.nodes.registerType('homie-convention-device', {
    category: 'Homie convention',
    color: '#FFAAAA',
    defaults: {
      broker: {value: '', type: 'homie-convention-broker-config', required: true},
      name: {value: ''},
      deviceID: {value: '[any]', required: true},
      nodeID: {value: '[any]', required: true},
      propertyID: {value: '[any]', required: true},
      topic: {value: ''},
      infoAttributes: {value: true},
      infoTiming: {value: true},
      infoError: {value: true},
      addLabel: {value: 'none'},
      labelTopic: {value: false},
      labelPayload: {value: true},
      labelName: {value: ''},
      uiPlaceName: {value: ''}, // placeholder Name;
      uiNode: {value: 'none'}, // type of UI Node
      uiControlDropdown: {value: true}, // controll dropdown via ui_control
      uiControlMinMax: {value: true}, // controll min max via ui_control
      uiColor1: {value: '#FFFFFF'}, // foreground colors
      uiBgColor1: {value: '#FFFFFF'}, // background colors
      uiColorON: {value: '#FFFFFF'},
      uiColorOFF: {value: '#FFFFFF'},
      uiColorPredicted: {value: '#FFFFFF'},
      uiUseColorPredicted: {value: false},
      uiColorPredictedOff: {value: '#FFFFFF'},
      uiUseColorPredictedOff: {value: false},
      uiFormat: {value: false},
      uiTooltip: {value: ''}, // tooltip Text
      uiIcon1: {value: ''}, // icon
      uiIconON: {value: ''}, // ON icon
      uiIconOFF: {value: ''}, // OFF icon
      uiSwitchPredicted: {value: false}, // use predicted state for switches
      uiSwitchColorPredictedON: {value: '#AAAAAA'},
      uiSwitchColorPredictedOFF: {value: '#AAAAAA'},
      uiSwitchIconPredictedON: {value: 'fa-toggle-on'},
      uiSwitchIconPredictedOFF: {value: 'fa-toggle-off'},
      settable: {value: false}
    },
    inputs: 1,
    outputs: 2,
    icon: "homie.png",
    label: function() {
      this.topic= this.deviceID;
      this.topic += '/'+this.nodeID;
      this.topic += '/'+this.propertyID;
      return this.name||this.topic||"homie itemp";
    },
    oneditprepare: function() {	
      var tabs = RED.tabs.create({
            id: "node-config-homie-tabs",
                onchange: function(tab) {
                    $("#node-config-homie-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });

            tabs.addTab({
                id: "homie-tab-basic",
                label: this._("basic")
            });
            tabs.addTab({
                id: "homie-tab-dashboard",
                label: this._("dashboard")
            });
            tabs.addTab({
                id: "homie-tab-extra",
                label: this._("extra")
            });

   
      treeList = $("<div>")
            .css({width: "100%", height: "100%"})
            .appendTo(".node-homie-data-row")
            .treeList({})
            .on('treelistitemmouseover',function(e,item) {
                if (item.node) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            })
            .on('treelistitemmouseout',function(e,item) {
                if (item.node) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            });
      treeList.treeList('data',[{label:"empty"}]);
      var brokerNodeId = $("#node-input-broker").val();

      if (!brokerNodeId) {
        	// No config node has been specified, so no use to connect to the server ...
          return;
      }

      configEditPrepare(this, true);
    },
    oneditresize: resizeNodeList
  });
</script>

<script type="text/x-red" data-help-name="homie-convention-device">
  <p> <img src="https://homieiot.github.io/img/mqtt_homie.jpg"></img>
  </p>
  <p>
    A message is emitted when a specific message for a homie device, node or property arrives. Optionally it sends attribute updates too.
    Use the input to send messages to <i>settable</i> properties. 
  </p>
  <p></p>
	<b>Configuration</b>
    <ul>
        <li><b>Name :</b> Optionally specify a name</li>
        <li><b>Broker :</b> Select the mqtt broker where your device is sending messages to.</li>
    </ul>

  <h3>basic configuration</h3>
    <ul>
      <li><b>Settable :</b> Properties list will only show settable properties.</li>
      <li><b>Device :</b> Optionally select the device to address. If specified, it filters messages messages from a specific device.</li>
      <li><b>Node :</b> Optionally select the node to address. If specified, it filters messages messages from a specific device.</li>
      <li><b>Property :</b> Optionally select the property to address. If specified, the node only emmits updates from a specific property. Nessesary for settable properties.</li>
    </ul>

  <h3>dashboard configuration</h3>
    <p>
        The homie node can do the configuration of dashboard nodes according to the informations provided by the information provided through the auto-discover functionality.
        refere to the full documentation for details.
    </p>
    <ul>
        <li><b>ui node :</b> select the type of node you like to connect to the output. Individual options will appear. Most of the options are set by using the ui_conftol object.</li>
        <li>button</li>
        <ul>
          <li><b>Label :</b> Color of the label text</li>
          <li><b>Background :</b> Background color of the button</li>
          <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
        </ul>
        <li>button as switch</li>
        <ul>
            <li><b>Label :</b> Color of the label text</li>
            <li><b>Background :</b> Background color of the button</li>
            <li><b>ON :</b> color for true/on state</li>
            <li><b>OFF :</b> color for false/off state</li>
            <li><b>predicted ON :</b> check if you whant that the button have this color when set to ON until a new state on the imput arrives</li>
            <li><b>predicted OFF :</b> check if you whant that the button have this color when set to OFF until a new state on the imput arrives</li>
            <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
        </ul>
        <li>chart</li>
        <ul>
            <li><b>min max :</b> use $format paramter to set ui_control.max and ui_controll.min</li>
        </ul>
        <li>color picker</li>
        <ul>
            <li><b>format :</b> use $format to set ui_controll.format to rgb or hsv</li>
        </ul>
        <li>dropdown</li>
        <ul>
            <li><b>format :</b> use $format to fill option list</li>
        </ul>
        <li>gauge, numeric, slider</li>
        <ul>
            <li><b>min max :</b> use $format paramter to set ui_control.max and ui_controll.min</li>
        </ul>
        <li>switch</li>
        <ul>
          <li><b>ON :</b> color for true/on state</li>
          <li><b>OFF :</b> color for false/off state</li>
          <li><b>predicted:</b> use predicted state after sending new message until new value received on input</li>
          <li><b>predicted ON :</b> optional color and icon for ON predicted state</li>
          <li><b>predicted OFF :</b> optional color and icon for ON predicted state</li>
          <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
          <li><b>ON icon:</b> optional icon for true/on state</li>
          <li><b>OFF icon:</b> optional icon for false/off state</li>
        </ul>
        <li>text</li>
        <ul>
          <li><b>format :</b> use $unit for <code>{{value}} $unit</code> if available</li>
        </ul>
        <li>text imput</li>
        <ul>
          <li>no ui_contol parameters usefull</li>
        </ul>

        <li><b>msg.label :</b> Select add label (i.e. for chart ui node) $name attribute will be used.</li>
    </ul>

  <h3>extra configuration</h3>
    <p>
        Additional information like timing, errors and atrributes can be added to the msg object
    </p>
    <ul>
        <li><b>msg.timing :</b> Select to receive timing information.</li>
        <li><b>msg.error :</b> Select to receive error information. All Errors will be sent on 2nd output</li>
        <li><b>msg.attributes :</b> Select to receive attributes information.</li>
   	 </ul>
	<p></p>

  <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">number | string | buffer</span>
        </dt>
        <dd> the payload of the message to send to the homie device. </dd>
        <dt class="optional">topic <span class="property-type">string</span></dt>
        <dd> the homie topic to publish to. This can override the node configuration. If empty the node settings will be used. If not matching a known propery topic will be ignored.</dd>
    </dl>

 <h3>Outputs</h3>
     <ol class="node-ports">
         <li>Standard output
             <dl class="message-properties">
                 <dt>msg.payload <span class="property-type">string | number</span></dt>
                 <dd>the standard output of a sucsessfull received update. Depending on the datatype as a String or number.</dd>

                 <dt>msg.topic <span class="property-type">string</span></dt>
                 <dd>Topic of the value: deviceID/nodeID/propertyID.</dd>

                 <dt>msg.device <span class="property-type">string</span></dt>
                 <dd>Name of the device the message came from</dd>

                 <dt>msg.node <span class="property-type">string</span></dt>
                 <dd>Name of the node the message came from</dd>

                 <dt>msg.property <span class="property-type">string</span></dt>
                 <dd>Name of the property emotting this message</dd>

                 <dt>msg.attributes.datatype <span class="property-type">string</span></dt>
                 <dd>value of the <a href="https://homieiot.github.io/specification/spec-core-v3_0_1/#property-attributes">$datatype</a> attribute.</dd>

                 <dt>msg.attributes.format <span class="property-type">string</span></dt>
                 <dd>value of the <a href="https://homieiot.github.io/specification/spec-core-v3_0_1/#property-attributes">$format</a> attribute.</dd>
 
                 <dt>msg.attributes.unit <span class="property-type">string</span></dt>
                 <dd>value of the <a href="https://homieiot.github.io/specification/spec-core-v3_0_1/#property-attributes">$unit</a> attribute.</dd>

                 <dt>msg.label <span class="property-type">string</span></dt>
                 <dd>value of the <a href="https://homieiot.github.io/specification/spec-core-v3_0_1/#property-attributes">$name</a> attribute. Usefull for chart UI node.</dd>

             </dl>
         </li>
         <li>Standard error
             <dl class="message-properties">
                 <dt>payload <span class="property-type">object</span></dt>
                 <dd>the standard error of the command.</dd>
             </dl>
         </li>
     </ol>

  <h3>Details</h3>
    <p>
        The Homie convention defines a standardized way of how IoT devices and services announce themselves and their data on the MQTT broker.<br>
        It is thereby a crucial aspect on top of the MQTT protocol for <i>automatic discovery, configuration</i> and <i>usage</i> of devices and services.<br>
        Form more Information head over to <a href="https://homieiot.github.io/">https://homieiot.github.io/</a>
    </p>  

  <h3>References</h3>
    <ul>
        <li><a href="https://homieiot.github.io/">Homie Convetion</a> - full specification of the Homie Convetion</li>
        <li><a href="https://github.com/Christian-Me/node-red-contrib-homie-convention">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
