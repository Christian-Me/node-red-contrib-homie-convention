<script type="text/html text/x-red" data-template-name="homie-convention-dashboard">

    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
      <label><i class="fa fa-ban"></i> /set</label>
      <input type="checkbox" id="node-input-uiBlockSet" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-uiBlockSet" style="width: 70%;">&nbsp;&nbsp;block <b>/set</b> messages</code></label>
    </div>

    <div class="form-row">
      <label><i class="fa fa-ban"></i> predicted</label>
      <input type="checkbox" id="node-input-uiBlockPredicted" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-uiBlockPredicted" style="width: 70%;">&nbsp;&nbsp;block <b>predicted</b> messages</code></label>
    </div>

    <div class="form-row">
      <label><i class="fa fa-ban"></i> predicted</label>
      <input type="checkbox" id="node-input-uiPredictedDisable" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-uiPredictedDisable" style="width: 70%;">&nbsp;&nbsp;send <code>msg.enable=false</code> during predicted state</label>
    </div>

    <div class="form-row">
      <label><i class="fa fa-ban"></i> predicted</label>
      <input type="checkbox" id="node-input-uiStateDisable" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-uiStateDisable" style="width: 70%;">&nbsp;&nbsp;send <code>msg.enable</code> $state==ready</label>
    </div>

    <div class="form-row">
      <label for="node-input-uiNode"><i class="fa fa-tachometer"></i> Node</label>
      <select id="node-input-uiNode">
        <option value="none">none</option>
        <option value="uiButton">button</option>
        <option value="uiButtonSwitch">button as switch</option>
        <option value="uiChart">chart</option>
        <option value="uiColor">color picker</option>
        <option value="uiDropdown">dropdown</option>
        <option value="uiGauge">gauge</option>
        <option value="uiNumeric">numeric</option>
        <option value="uiSlider">slider</option>
        <option value="uiSwitch">switch</option>
        <option value="uiText">text</option>
        <option value="uiTextImput">text imput</option>
      </select>
    </div>

    <div id="node-config-homie-uiOptions">

      <div id="node-config-homie-uiOption-uiDropdown" style="display:none">
        <div class="form-row">
          <label for="node-input-uiPlaceName"><i class="fa fa-info"></i> Placeholder</label>
          <input type="text" id="node-input-uiPlaceName" placeholder="enter placeholder text">
        </div>
        <div class="form-row">
          <label><i class="fa fa-list"></i> ui_control</label>
          <input type="checkbox" id="node-input-uiControlDropdown" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiControlDropdown" style="width: 70%;">&nbsp;&nbsp;convert <b>$datatype</b> and <b>$format</b> to <code>msg.ui_control</code></label>
        </div>
      </div>
      
      <div id="node-config-homie-uiOption-uiMinMax" style="display:none">
        <div class="form-row">
          <label><i class="fa fa-sliders"></i> ui_control</label>
          <input type="checkbox" id="node-input-uiControlMinMax" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiControlMinMax" style="width: 70%;">&nbsp;&nbsp;convert <b>$format</b> <b>min:max</b> to <code>msg.ui_control</code></label>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiFormat" style="display:none">
        <div class="form-row">
          <label><i class="fa fa-sliders"></i> ui_control</label>
          <input type="checkbox" id="node-input-uiFormat" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiFormat" style="width: 70%;">&nbsp;&nbsp;use <b>$unit</b> for <b>Format:</b> <code>{{value}} $unit</code></label>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiColorPicker" style="display:none">
        <div class="form-row">
          <label for="node-input-uiFormatColor"><i class="fa fa-sliders"></i> Color Format</label>
          <select id="node-input-uiFormatColor">
            <option value="homieString">Homie String</option>
            <option value="nodeRedObject">Node-RED object</option>
            <option value="nodeRedString">Node-RED string</option>>
          </select>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiColorButton" style="display:none">
        <div class="form-row">
          <label><i class="fa fa-bold"></i> Label</label>
          <input type="color" id="node-input-uiColor1" class="nr-db-field-themeColor"  style="position:initial;">
          <label for="node-input-uiColor1" style="width: 70%;">&nbsp;&nbsp;foreground color for icon and text</label>
        </div>
        <div class="form-row">
            <label><i class="fa fa-square"></i> Background</label>
            <input type="color" id="node-input-uiBgColor1" class="nr-db-field-themeColor"  style="position:initial;">
            <label for="node-input-uiBgColor1" style="width: 70%;">&nbsp;&nbsp;background color</label>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiColorSwitch" style="display:none"> 
        <div class="form-row">
            <label><i class="fa fa-check-square-o"></i> ON</label>
            <input type="color" id="node-input-uiColorON" class="nr-db-field-themeColor"  style="position:initial;">
            <label for="node-input-uiColorON" style="width: 70%;">&nbsp;&nbsp;color for <B>true/on</b> state</label>
        </div>
        <div class="form-row">
          <label><i class="fa fa-square-o"></i> OFF</label>
          <input type="color" id="node-input-uiColorOFF" class="nr-db-field-themeColor"  style="position:initial;">
          <label for="node-input-uiColorOFF" style="width: 70%;">&nbsp;&nbsp;color for <B>false/off</b> state</label>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiColorPredicted" style="display:none"> 
        <div class="form-row">
          <label><i class="fa fa-question-circle-o"></i> predicted</label>
          <input type="color" id="node-input-uiColorPredicted" class="nr-db-field-themeColor"  style="position:initial;">
          <label for="node-input-uiColorPredicted" style="width: 1%;">&nbsp;&nbsp</label>
          <input type="checkbox" id="node-input-uiUseColorPredicted" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiUseColorPredicted" style="width: 50%;">&nbsp;&nbsp;use color for <b>predicted</b> ON state</label>
        </div>
        <div class="form-row">
          <label><i class="fa fa-question-circle-o"></i></label>
          <input type="color" id="node-input-uiColorPredictedOff" class="nr-db-field-themeColor"  style="position:initial;">
          <label for="node-input-uiColorPredictedOff" style="width: 1%;">&nbsp;&nbsp</label>
          <input type="checkbox" id="node-input-uiUseColorPredictedOff" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiUseColorPredictedOff" style="width: 50%;">&nbsp;&nbsp;use color for <b>predicted</b> OFF state</label>
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiSwitchPredicted" style="display:none"> 
        <div class="form-row">
          <label><i class="fa fa-refresh"></i> ui_control</label>
          <input type="checkbox" id="node-input-uiSwitchPredicted" style="display: inline-block; width: auto; vertical-align: top;">
          <label for="node-input-uiSwitchPredicted" style="width: 70%;">&nbsp;&nbsp;use predicted state until confirmation received</label>
        </div>
      </div>


      <div id="node-config-homie-uiOption-uiUseSwitchPredicted" style="display:none"> 
          <div class="form-row">
            <label></label>
            <label for="node-input-uiSwitchColorPredictedON" style="width: 5%;">ON </label>
            <input type="color" id="node-input-uiSwitchColorPredictedON" class="nr-db-field-themeColor"  style="position:initial;">
            <label for="node-input-uiSwitchIconPredictedON" style="width: 10%;">&nbsp;&nbsp;Icon</label>
            <input type="text" id="node-input-uiSwitchIconPredictedON" style="width: 40%;" splaceholder="Material, fa or Weather Icon">
          </div>
          <div class="form-row">
            <label></label>
            <label for="node-input-uiSwitchColorPredictedOFF" style="width: 5%;">OFF </label>
            <input type="color" id="node-input-uiSwitchColorPredictedOFF" class="nr-db-field-themeColor"  style="position:initial;">
            <label for="node-input-uiSwitchIconPredictedOFF" style="width: 10%;">&nbsp;&nbsp;Icon</label>
            <input type="text" id="node-input-uiSwitchIconPredictedOFF" style="width: 40%;" splaceholder="Material, fa or Weather Icon">
          </div>
        </div>

      <div id="node-config-homie-uiOption-uiTooltip" style="display:none">
        <div class="form-row">
          <label for="node-input-uiTooltip"><i class="fa fa-info"></i>&nbsp;Tooltip</label>
          <input type="text" id="node-input-uiTooltip" placeholder="enter tooltip text">
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiIcon1" style="display:none">
        <div class="form-row">
          <label for="node-input-uiIcon1"><i class="fa fa-info"></i>&nbsp;Icon</label>
          <input type="text" id="node-input-uiIcon1" placeholder="Material, fa or Weather Icon">
        </div>
      </div>

      <div id="node-config-homie-uiOption-uiIcon2" style="display:none">
        <div class="form-row">
          <label for="node-input-uiIconON"><i class="fa fa-info"></i>&nbsp;ON icon</label>
          <input type="text" id="node-input-uiIconON" placeholder="Material, fa or Weather Icon">
        </div>
        <div class="form-row">
          <label for="node-input-uiIconOFF"><i class="fa fa-info"></i>&nbsp;OFF icon</label>
          <input type="text" id="node-input-uiIconOFF" placeholder="Material, fa or Weather Icon">
        </div>
      </div>

    </div>

    <div class="form-row">
      <label for="node-input-addLabel"><i class="fa fa-tags"></i> <code>msg.label</code></label>
      <select id="node-input-addLabel">
          <option value="none">none</option>
          <option value="name">$name</option>
          <option value="custom">custom</option>
          <option value="device">device</option>
          <option value="node">node</option>
          <option value="property">property</option>
          <option value="device/node/property">Device/Node/Property</option>
          <option value="device/node">Device/Node</option>
      </select>
    </div>
    <div id="node-config-homie-labelOptions">
      <div id="node-config-homie-labelOption-custom" style="display:none">
        <div class="form-row">
          <label for="node-input-labelName"><i class="fa fa-label"></i> Custom Label</label>
          <input type="text" id="node-input-labelName" placeholder="$name if empty">
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">

function configEditPrepareHomieDashboard(node) {

  function setColourPickerColour(id, val, ed) {
                $("#"+id).val(val);
                $("#"+id).css("background-color", val);
            }

  function updateUiNodeOptions(cntrlConfig, valueID, itemName) {
    $("#node-config-homie-uiOptions").children().hide();
    switch(itemName) {
      case 'uiNumeric':
        $("#node-config-homie-uiOption-uiMinMax").show();
        $("#node-config-homie-uiOption-uiFormat").show();
        break;
      case 'uiGauge':
        $("#node-config-homie-uiOption-uiMinMax").show();
        break;
      case 'uiSlider':
        $("#node-config-homie-uiOption-uiMinMax").show();
        break;
      case 'uiChart':
        $("#node-config-homie-uiOption-uiMinMax").show();
        break
      case 'uiDropdown':
        $("#node-config-homie-uiOption-uiDropdown").show();
        break;
      case 'uiButton':
        $("#node-config-homie-uiOption-uiColorButton").show();
        $("#node-config-homie-uiOption-uiTooltip").show();
        $("#node-config-homie-uiOption-uiIcon1").show();
        break;
      case 'uiButtonSwitch':
        $("#node-config-homie-uiOption-uiColorButton").show();
        $("#node-config-homie-uiOption-uiColorSwitch").show();
        $("#node-config-homie-uiOption-uiColorPredicted").show();
        $("#node-config-homie-uiOption-uiTooltip").show();
        $("#node-config-homie-uiOption-uiIcon1").show();
        break;
      case 'uiSwitch':
        $("#node-config-homie-uiOption-uiColorSwitch").show();
        $("#node-config-homie-uiOption-uiTooltip").show();
        $("#node-config-homie-uiOption-uiIcon2").show();
        $("#node-config-homie-uiOption-uiSwitchPredicted").show();
        if ($('#node-input-uiSwitchPredicted').is(':checked')) $("#node-config-homie-uiOption-uiUseSwitchPredicted").show();
          else $("#node-config-homie-uiOption-uiUseSwitchPredicted").hide();
        break;
      case 'uiText':
        $("#node-config-homie-uiOption-uiFormat").show();
        break;
      case 'uiColor':
        $("#node-config-homie-uiOption-uiColorPicker").show();
        break;
    }
  };

  function updateUiLabelOptions(cntrlConfig, valueID, itemName) {
    $("#node-config-homie-labelOptions").children().hide();
    switch(itemName) {
      case 'none': break;
      case 'custom': 
        $("#node-config-homie-labelOption-" + itemName).show();
        $("#node-config-homie-labelOption-name").show();
        break;
      default: $("#node-config-homie-labelOption-name").show();
    }
  };

  setColourPickerColour("node-input-uiColor1", node.uiColor1);
  $('#node-input-uiColor1').change(function(ev) {
    setColourPickerColour("node-input-uiColor1", $('#node-input-uiColor1').val() || node.uiColor1);
  });
  setColourPickerColour("node-input-uiBgColor1", node.uiBgColor1);
  $('#node-input-uiBgColor1').change(function(ev) {
    setColourPickerColour("node-input-uiBgColor1", $('#node-input-uiBgColor1').val() || node.uiBgColor1);
  });
  setColourPickerColour("node-input-uiColorON", node.uiColorON);
  $('#node-input-uiColorON').change(function(ev) {
    setColourPickerColour("node-input-uiColorON", $('#node-input-uiColorON').val() || node.uiColorON);
  });
  setColourPickerColour("node-input-uiColorOFF", node.uiColorOFF);
  $('#node-input-uiColorOFF').change(function(ev) {
    setColourPickerColour("node-input-uiColorOFF", $('#node-input-uiColorOFF').val() || node.uiColorOFF);
  });
  setColourPickerColour("node-input-uiColorPredicted", node.uiColorPredicted);
  $('#node-input-uiColorPredicted').change(function(ev) {
    setColourPickerColour("node-input-uiColorPredicted", $('#node-input-uiColorPredicted').val() || node.uiColorPredicted);
  });
  setColourPickerColour("node-input-uiColorPredictedOff", node.uiColorPredictedOff);
  $('#node-input-uiColorPredictedOff').change(function(ev) {
    setColourPickerColour("node-input-uiColorPredictedOff", $('#node-input-uiColorPredictedOff').val() || node.uiColorPredictedOff);
  });
  setColourPickerColour("node-input-uiSwitchColorPredictedON", node.uiSwitchColorPredictedON);
  $('#node-input-uiSwitchColorPredictedON').change(function(ev) {
    setColourPickerColour("node-input-uiSwitchColorPredictedON", $('#node-input-uiSwitchColorPredictedON').val() || node.uiSwitchColorPredictedON);
  });
  setColourPickerColour("node-input-uiSwitchColorPredictedOFF", node.uiSwitchColorPredictedOFF);
  $('#node-input-uiSwitchColorPredictedOFF').change(function(ev) {
    setColourPickerColour("node-input-uiSwitchColorPredictedOFF", $('#node-input-uiSwitchColorPredictedOFF').val() || node.uiSwitchColorPredictedOFF);
  });
  $('#node-input-uiSwitchPredicted').change(function(ev) {
    if ($('#node-input-uiNode').val()=='uiSwitch' && $('#node-input-uiSwitchPredicted').is(':checked')) $("#node-config-homie-uiOption-uiUseSwitchPredicted").show();
      else $("#node-config-homie-uiOption-uiUseSwitchPredicted").hide();
  });
  $('#node-input-uiNode').change(function(ev) { // update uiNode features
    updateUiNodeOptions(RED.nodes.node($('#node-input-broker').val()),'', $('#node-input-uiNode').val() || node.uiNode);
  });
  $('#node-input-addLabel').change(function(ev) { // update uiLabel features
    updateUiLabelOptions(RED.nodes.node($('#node-input-broker').val()),'', $('#node-input-addLabel').val() || node.addLabel);
  });
  $('#node-input-settable').on("click",function() { // re-update property list if $settable filter setting is changed
    updateItemSelection(RED.nodes.node($('#node-input-broker').val()),'propertyID', $('#node-input-propertyID').val() || node.propertyID);
  });
}


  RED.nodes.registerType('homie-convention-dashboard', {
    category: 'Homie convention',
    paletteLabel: 'dashboard',
    label: 'Homie dashboard',
    color: '#AA2517',
    defaults: {
      name: {value: ''},
      addLabel: {value: 'none'},
      labelName: {value: ''},
      uiBlockSet: {value: true},
      uiBlockPredicted: {value: true},
      uiPredictedDisable: {value: false},
      uiStateDisable: {value: false},
      uiPlaceName: {value: ''}, // placeholder Name;
      uiNode: {value: 'none'}, // type of UI Node
      uiControlDropdown: {value: true}, // control dropdown via ui_control
      uiControlMinMax: {value: true}, // control min max via ui_control
      uiColor1: {value: '#FFFFFF'}, // foreground colors
      uiBgColor1: {value: '#FFFFFF'}, // background colors
      uiColorON: {value: '#FFFFFF'},
      uiColorOFF: {value: '#FFFFFF'},
      uiColorPredicted: {value: '#FFFFFF'},
      uiUseColorPredicted: {value: false},
      uiColorPredictedOff: {value: '#FFFFFF'},
      uiUseColorPredictedOff: {value: false},
      uiFormat: {value: false},
      uiTooltip: {value: ''}, // tooltip Text
      uiIcon1: {value: ''}, // icon
      uiIconON: {value: ''}, // ON icon
      uiIconOFF: {value: ''}, // OFF icon
      uiSwitchPredicted: {value: false}, // use predicted state for switches
      uiSwitchColorPredictedON: {value: '#AAAAAA'},
      uiSwitchColorPredictedOFF: {value: '#AAAAAA'},
      uiSwitchIconPredictedON: {value: 'fa-toggle-on'},
      uiSwitchIconPredictedOFF: {value: 'fa-toggle-off'},
      uiFormatColor: {value: 'homieString'},
    },
    inputs: 1,
    outputs: 1,
    icon: "Homie-device-logo.svg",
    label: function() {
        return this.name || "homie dashboard";
    },
    oneditprepare: function() {
      let node = this;

      configEditPrepareHomieDashboard(this);
    },

    oneditsave: function() { 
      let node = this;
    },
    oneditcancel: function() {
      let node = this;
    },
    oneditresize: function(size) {
      let node = this;
    }
  });
</script>

<script type="text/html text/x-red" data-help-name="homie-convention-dashboard">
  <p> 
    <a href="https://homieiot.github.io/">
      <img src="https://homieiot.github.io/img/works-with-homie.png" alt="works with MQTT Homie">
    </a>
  </p>
  <p>
    The homie convention provides some auto discover features which can be used to configure dashboard nodes automatically. 
  </p>
  <p></p>
	<b>Configuration</b>
  <ul>
      <li><b>Name :</b> Optionally specify a name</li>
      <li><b>block set :</b> Select to block /set messages in order to show only confirmed values.</li>
      <li><b>block predicted :</b> Select to block predicted messages in order to show values confirmed by the device. Uncheck to use some features to indicate predicted values</li>
  </ul>

  <h3>dashboard configuration</h3>
    <ul>
        <li><b>ui node :</b> select the type of node you like to connect to the output. Individual options will appear. Most of the options are set by using the ui_control object.</li>
        <li>button</li>
        <ul>
          <li><b>Label :</b> Color of the label text</li>
          <li><b>Background :</b> Background color of the button</li>
          <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
        </ul>
        <li>button as switch</li>
        <ul>
            <li><b>Label :</b> Color of the label text</li>
            <li><b>Background :</b> Background color of the button</li>
            <li><b>ON :</b> color for true/on state</li>
            <li><b>OFF :</b> color for false/off state</li>
            <li><b>predicted ON :</b> check if you want that the button have this color when set to ON until a new state on the input arrives</li>
            <li><b>predicted OFF :</b> check if you want that the button have this color when set to OFF until a new state on the input arrives</li>
            <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
        </ul>
        <li>chart</li>
        <ul>
            <li><b>min max :</b> use $format paramter to set ui_control.max and ui_control.min</li>
        </ul>
        <li>color picker</li>
        <ul>
            <li><b>format :</b> use $format to set ui_control.format to rgb or hsv</li>
        </ul>
        <li>dropdown</li>
        <ul>
            <li><b>format :</b> use $format to fill option list</li>
        </ul>
        <li>gauge, numeric, slider</li>
        <ul>
            <li><b>min max :</b> use $format paramter to set ui_control.max and ui_control.min</li>
        </ul>
        <li>switch</li>
        <ul>
          <li><b>ON :</b> color for true/on state</li>
          <li><b>OFF :</b> color for false/off state</li>
          <li><b>predicted:</b> use predicted state after sending new message until new value received on input</li>
          <li><b>predicted ON :</b> optional color and icon for ON predicted state</li>
          <li><b>predicted OFF :</b> optional color and icon for ON predicted state</li>
          <li><b>Tooltip :</b> Tooltip if user hoovers over the element. Needs reload of the dashboard to appear.</li>
          <li><b>ON icon:</b> optional icon for true/on state</li>
          <li><b>OFF icon:</b> optional icon for false/off state</li>
        </ul>
        <li>text</li>
        <ul>
          <li><b>format :</b> use $unit for <code>{{value}} $unit</code> if available</li>
        </ul>
        <li>text input</li>
        <ul>
          <li>no ui_control parameters useful</li>
        </ul>

        <li><b>msg.label :</b> Select add label (i.e. for chart ui node) $name attribute will be used.</li>
    </ul>

  <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg
            <span class="property-type">object</span>
        </dt>
        <dd> data from a homie device node or homie pro node.</dd>
    </dl>

 <h3>Outputs</h3>
     <ol class="node-ports">
         <li>Standard output
             <dl class="message-properties">
                 <dt>msg<span class="property-type">object</span></dt>
                 <dd>message prepared for selected dashboard nodes.</dd>
             </dl>
         </li>
     </ol>

  <h3>Details</h3>
    <p>
        The Homie convention defines a standardized way of how IoT devices and services announce themselves and their data on the MQTT broker.<br>
        It is thereby a crucial aspect on top of the MQTT protocol for <i>automatic discovery, configuration</i> and <i>usage</i> of devices and services.<br>
        Form more Information head over to <a href="https://homieiot.github.io/">https://homieiot.github.io/</a>
    </p>  

  <h3>References</h3>
    <ul>
        <li><a href="https://homieiot.github.io/">Homie Convention</a> - full specification of the Homie Convention</li>
        <li><a href="https://github.com/Christian-Me/node-red-contrib-homie-convention">GitHub</a> - the nodes github repository</li>
    </ul>
</script>
